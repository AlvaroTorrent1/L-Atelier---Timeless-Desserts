---
import { languages } from '../i18n/ui';
import { getLangFromUrl, getLocalizedUrl } from '../i18n/utils';

const currentLang = getLangFromUrl(Astro.url);
const currentLangName = languages[currentLang as keyof typeof languages];
---

<div class="relative" data-language-selector>
  <button 
    class="group flex items-center gap-2 text-sm tracking-wider hover:text-accent transition-colors duration-300 py-2 px-1"
    data-lang-toggle
    aria-label="Select language"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <!-- Globe Icon - Elegant thin stroke -->
    <svg 
      class="w-5 h-5 opacity-70 group-hover:opacity-100 transition-opacity" 
      viewBox="0 0 24 24" 
      fill="none" 
      stroke="currentColor" 
      stroke-width="1.2"
    >
      <circle cx="12" cy="12" r="10"/>
      <path d="M2 12h20"/>
      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
    </svg>
    
    <!-- Current Language -->
    <span class="uppercase font-light opacity-80 group-hover:opacity-100 transition-opacity">
      {currentLang}
    </span>
    
    <!-- Chevron -->
    <svg 
      class="w-3 h-3 opacity-50 group-hover:opacity-80 transition-all duration-300 ease-out" 
      data-lang-arrow 
      viewBox="0 0 12 12" 
      fill="none"
    >
      <path d="M3 5L6 8L9 5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
  
  <!-- Dropdown Menu -->
  <div 
    class="absolute top-full right-0 mt-3 py-3 bg-white border border-primary/10 opacity-0 pointer-events-none transition-all duration-300 ease-out translate-y-2 shadow-lg min-w-[160px] z-50"
    data-lang-dropdown
    role="menu"
  >
    <!-- Decorative accent line -->
    <div class="absolute top-0 left-4 right-4 h-px bg-gradient-to-r from-transparent via-accent/30 to-transparent"></div>
    
    {Object.entries(languages).map(([code, name]) => (
      <a 
        href={getLocalizedUrl(Astro.url, code)}
        class:list={[
          "flex items-center gap-3 px-5 py-2.5 text-sm tracking-wide transition-all duration-200",
          code === currentLang 
            ? "text-accent bg-secondary/30" 
            : "text-primary/70 hover:text-primary hover:bg-secondary/20 hover:pl-6"
        ]}
        role="menuitem"
      >
        <!-- Checkmark for active language -->
        {code === currentLang && (
          <svg class="w-4 h-4 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        )}
        <span class={code !== currentLang ? "ml-7" : ""}>{name}</span>
      </a>
    ))}
  </div>
</div>

<script>
  function initLanguageSelector() {
    const selectors = document.querySelectorAll('[data-language-selector]');
    
    selectors.forEach(selector => {
      const toggle = selector.querySelector('[data-lang-toggle]');
      const dropdown = selector.querySelector('[data-lang-dropdown]');
      const arrow = selector.querySelector('[data-lang-arrow]');
      
      if (!toggle || !dropdown || !arrow) return;

      let isOpen = false;
      
      const openDropdown = () => {
        isOpen = true;
        toggle.setAttribute('aria-expanded', 'true');
        dropdown.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-2');
        dropdown.classList.add('opacity-100', 'pointer-events-auto', 'translate-y-0');
        arrow.classList.add('rotate-180');
      };

      const closeDropdown = () => {
        isOpen = false;
        toggle.setAttribute('aria-expanded', 'false');
        dropdown.classList.add('opacity-0', 'pointer-events-none', 'translate-y-2');
        dropdown.classList.remove('opacity-100', 'pointer-events-auto', 'translate-y-0');
        arrow.classList.remove('rotate-180');
      };

      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        isOpen ? closeDropdown() : openDropdown();
      });
      
      document.addEventListener('click', (e) => {
        if (!selector.contains(e.target as Node)) {
          closeDropdown();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isOpen) {
          closeDropdown();
        }
      });
    });
  }
  
  initLanguageSelector();
  document.addEventListener('astro:after-swap', initLanguageSelector);
</script>
