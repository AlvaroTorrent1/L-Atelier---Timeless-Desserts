---
interface Props {
  as?: keyof HTMLElementTagNameMap;
  class?: string;
  delay?: number; // Delay in milliseconds
  threshold?: number; // Intersection threshold (0-1)
}

const { 
  as: Tag = 'div',
  class: className = '',
  delay = 0,
  threshold = 0.1
} = Astro.props;
---

<Tag 
  class={`fade-in-element ${className}`}
  data-fade-in
  data-delay={delay}
  data-threshold={threshold}
>
  <slot />
</Tag>

<script>
  function initFadeIn() {
    const elements = document.querySelectorAll('[data-fade-in]');
    
    if (!elements.length) return;
    
    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    
    if (prefersReducedMotion) {
      // If user prefers reduced motion, show elements immediately
      elements.forEach(el => {
        (el as HTMLElement).style.opacity = '1';
        (el as HTMLElement).style.transform = 'none';
      });
      return;
    }
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const element = entry.target as HTMLElement;
          const delay = parseInt(element.dataset.delay || '0');
          
          setTimeout(() => {
            element.classList.add('visible');
          }, delay);
          
          observer.unobserve(element);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    });
    
    elements.forEach((el) => {
      observer.observe(el);
    });
  }
  
  // Initialize on page load and after view transitions
  initFadeIn();
  document.addEventListener('astro:after-swap', initFadeIn);
</script>

<style is:global>
  [data-fade-in] {
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s ease-out, transform 0.8s ease-out;
  }
  
  [data-fade-in].visible {
    opacity: 1;
    transform: translateY(0);
  }
</style>
