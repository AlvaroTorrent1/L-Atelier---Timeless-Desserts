---
import LanguageSelector from './LanguageSelector.astro';
import { getLangFromUrl, useTranslations, useTranslatedPath } from '../i18n/utils';

interface Props {
  transparent?: boolean;
}

const { transparent = false } = Astro.props;
const currentPath = Astro.url.pathname;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const navItems = [
  { href: translatePath('/about'), label: t('nav.about') },
  { href: translatePath('/patisseries'), label: t('nav.projects') },
  { href: translatePath('/contact'), label: t('nav.contact') },
];

function isActive(href: string): boolean {
  if (href === '/') return currentPath === '/';
  if (href === '/es' || href === '/fr') return currentPath === href || currentPath === `${href}/`;
  return currentPath.startsWith(href);
}
---

<header 
  class:list={[
    'fixed top-0 left-0 right-0 z-50 transition-all duration-300',
    transparent ? 'bg-transparent' : 'bg-background/90 backdrop-blur-sm'
  ]}
  data-header
  data-transparent={transparent.toString()}
>
  <nav class="max-w-7xl mx-auto px-6 lg:px-8 py-6 flex items-center justify-between">
    <!-- Logo -->
    <a 
      href={translatePath('/')} 
      class="hover:opacity-80 transition-opacity"
      aria-label="Home"
    >
      <img 
        src="/logo.svg" 
        alt="L'Atelier - Timeless Desserts" 
        class="h-20 md:h-24 w-auto"
      />
    </a>
    
    <!-- Desktop Navigation -->
    <ul class="hidden md:flex items-center gap-8">
      {navItems.map(({ href, label }) => (
        <li>
          <a 
            href={href}
            class:list={[
              'text-sm tracking-widest uppercase transition-opacity',
              isActive(href) ? 'opacity-100' : 'opacity-60 hover:opacity-100'
            ]}
          >
            {label}
          </a>
        </li>
      ))}
      <li class="ml-4 border-l border-primary/10 pl-8">
        <LanguageSelector />
      </li>
    </ul>
    
    <!-- Mobile Menu Button -->
    <button 
      class="md:hidden p-2 -mr-2"
      aria-label="Toggle menu"
      data-menu-toggle
    >
      <div class="w-6 flex flex-col gap-1.5" data-menu-icon>
        <span class="block h-px bg-current transition-transform origin-center"></span>
        <span class="block h-px bg-current transition-opacity"></span>
        <span class="block h-px bg-current transition-transform origin-center"></span>
      </div>
    </button>
  </nav>
  
  <!-- Mobile Menu -->
  <div 
    class="md:hidden fixed inset-0 bg-background z-40 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"
    data-mobile-menu
  >
    <div class="flex flex-col items-center gap-12">
      <ul class="flex flex-col items-center gap-8">
        {navItems.map(({ href, label }) => (
          <li>
            <a 
              href={href}
              class="text-2xl font-serif tracking-wide"
            >
              {label}
            </a>
          </li>
        ))}
      </ul>
      
      <div class="pt-8 border-t border-primary/10 w-full flex justify-center">
        <LanguageSelector />
      </div>
    </div>
  </div>
</header>

<script>
  function initHeader() {
    const header = document.querySelector('[data-header]') as HTMLElement;
    const menuToggle = document.querySelector('[data-menu-toggle]') as HTMLButtonElement;
    const mobileMenu = document.querySelector('[data-mobile-menu]') as HTMLElement;
    const menuIcon = document.querySelector('[data-menu-icon]') as HTMLElement;
    
    if (!header || !menuToggle || !mobileMenu || !menuIcon) return;

    let isMenuOpen = false;
    
    // Toggle mobile menu
    menuToggle?.addEventListener('click', () => {
      isMenuOpen = !isMenuOpen;
      
      if (isMenuOpen) {
        mobileMenu.classList.remove('opacity-0', 'pointer-events-none');
        mobileMenu.classList.add('opacity-100', 'pointer-events-auto');
        menuIcon.classList.add('menu-open');
        document.body.style.overflow = 'hidden';
      } else {
        mobileMenu.classList.add('opacity-0', 'pointer-events-none');
        mobileMenu.classList.remove('opacity-100', 'pointer-events-auto');
        menuIcon.classList.remove('menu-open');
        document.body.style.overflow = '';
      }
    });
    
    // Close menu on link click
    mobileMenu?.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        mobileMenu.classList.add('opacity-0', 'pointer-events-none');
        menuIcon.classList.remove('menu-open');
        document.body.style.overflow = '';
        isMenuOpen = false;
      });
    });
    
    // Header background on scroll
    let lastScroll = 0;
    window.addEventListener('scroll', () => {
      const currentScroll = window.scrollY;
      
      if (currentScroll > 100) {
        header.classList.remove('bg-transparent');
        header.classList.add('bg-background/90', 'backdrop-blur-sm');
      } else {
        if (header.dataset.transparent === 'true') {
          header.classList.add('bg-transparent');
          header.classList.remove('bg-background/90', 'backdrop-blur-sm');
        }
      }
      
      lastScroll = currentScroll;
    }, { passive: true });
  }
  
  // Initialize on page load and after view transitions
  initHeader();
  document.addEventListener('astro:after-swap', initHeader);
</script>

<style>
  /* Menu icon animation */
  [data-menu-icon].menu-open span:first-child {
    transform: translateY(5px) rotate(45deg);
  }
  
  [data-menu-icon].menu-open span:nth-child(2) {
    opacity: 0;
  }
  
  [data-menu-icon].menu-open span:last-child {
    transform: translateY(-5px) rotate(-45deg);
  }
</style>
